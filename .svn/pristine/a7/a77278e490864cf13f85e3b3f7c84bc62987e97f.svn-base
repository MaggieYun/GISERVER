#coding=utf-8
#author 许照云
import os,sys
from validation import *
from layer import *
from layerfactory import *

#以下代码逻辑有待调整，layerFactory作用未发挥



import tornado.web
class queryHandler(tornado.web.RequestHandler):
    
    def initialize(self,layersPath,layerPath,outfields):
        self.layersPath = layersPath
        self.layerPath = layerPath
        self.outfields = outfields

    def get(self):
        print u"获取参数"
        where = self.get_argument("where")  #从url中获取参数
        insr = self.get_argument("inSR")
        outsr = self.get_argument("outSR")
        bbox = map(lambda x:float(x),self.get_argument("bbox").split(","))
        size = map(lambda x:int(x),self.get_argument("size").split(","))


        queryParameter = QueryParameter(bbox,where,insr,self.outfields,outsr)

        layerFactory = LayerFactory(self.layersPath)

        layer1 = layerFactory.createLayer(self.layerPath)

        queryResult = layer1.query(queryParameter)


        result = queryResult.toString()

        self.write(result)

    post = get  


class exportHandler(tornado.web.RequestHandler):
    
    def initialize(self,layersPath,layerPath,outfields):
        self.layersPath = layersPath
        self.layerPath = layerPath
        self.outfields = outfields

    def get(self):
        print u"获取参数"
        where = self.get_argument("where")  #从url中获取参数
        insr = self.get_argument("inSR")
        outsr = self.get_argument("outSR")
        bbox = map(lambda x:float(x),self.get_argument("bbox").split(","))
        size = map(lambda x:int(x),self.get_argument("size").split(","))



        queryParameter = QueryParameter(bbox,where,insr,self.outfields,outsr)

        layerFactory = LayerFactory(self.layersPath)
        layer1 = layerFactory.createLayer(self.layerPath)

        im=layer1.export(queryParameter,size)

        imstr = im.tostring("png")
        self.set_header("Content-Type", "image/png")
        self.write(imstr)

    post = get  



















