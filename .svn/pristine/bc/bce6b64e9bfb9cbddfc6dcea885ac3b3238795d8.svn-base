#coding=utf-8
from store import *
from cache import *
import Image
class Layer:
    GRAPHICS = []

    def __init__(self,definition):
        
        self.definition = definition
        self.definition.set_layer(self)
        self.cache = TableCache(definition)
        self.cache.sync()  #这句代码必须放在上上句代码下面，否则没有self.definition.layer

        self.store=GiserverStore
        engine = self.definition.engine
        self.store.set_engine(engine)

    @classmethod
    def add_graphics(cls,graphics):
        cls.GRAPHICS = graphics

    
    def reload(self):
        pass

    def query(self,queryParameter):
        
        aliases_dict,features,export_results=self.cache.query(queryParameter)
        
        aliases = aliases_dict.values()
        fields = aliases_dict.keys()
        gemetryType = self.definition.gemetryType 
        
        queryResult = QueryResult(aliases,fields,features,gemetryType)
        # print queryResult.aliases
        # print queryResult.fields
        # print queryResult.features
        # print queryResult.type

        return queryResult,export_results  #export_results有待进一步调整数据结构，使其只返回queryResult，无干扰


    def export(self,queryParameter,size):
        #遍历缓存类graphic中所有的graphics，绘制出symbol（考虑可使用layer.add()方法）
        #1,获取结果集
        results = self.query(queryParameter)[1]
        results.img = Image.new("RGBA",size,(255,255,255,0))  #动态添加属性
        #2,从definition获取Rules,根据rule拆分results
        #queryResult添加一个fetch方法，返回满足rule的filter的数据集，并修改queryResult本身
        #fetch时，使用smybol绘制每个graphic，目的是减少循环遍历次数
        # filters = self.definition.style.rule.filter   #由函数组成的列表
        # symbols = self.definition.style.rule.symbol   #由symbol类组成的列表
        # n = len(filters)
        # for i in xrange(n):
        #     result = results.fetch(filters[i],symbols[i])
        
        # resultn = results.fetchall()#获取剩余数据，没有被filter包含的数据

        rules = self.definition.style.rule
        
        for rule in rules:
            f = rule.filter
            symbol = rule.symbol
            result = filter(f,results)
            for ele in result:
                symbol.draw(ele,size,bbox,img)

        return results.img
        
    def toScreen(self):
        pass

    def toGemtry(self):
        pass

class QueryParameter:
    def __init__(self,bbox,where,insr,outfields,outsr):
        self.bbox = bbox
        self.where = where
        self.insr = insr
        self.outfields = outfields.split(",")
        self.outsr = outsr

    @classmethod
    def create(cls,requestHandler):
        self.layer = requestHandler.get_argument("layer")
        self.bbox = requestHandler.get_argument("bbox")
        self.where = requestHandler.get_argument("where",None)
        self.insr = requestHandler.get_argument("insr")
        self.outfields = requestHandler.get_argument("outfields")
        self.outsr = requestHandler.get_argument("outsr")  

    def toString(self):
        pass    


class QueryResult:
    def __init__(self,aliases,fields,features,layer_type):
        self.aliases = aliases
        self.fields = fields
        self.features = features
        self.type = layer_type 

    def toString(self):
        pass    

    def fetch(self,rule):
        pass    






