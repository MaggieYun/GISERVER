#coding=utf-8
from store import *
from extent import *
class Layer:

    def __init__(self,definition):
        self.cache = None
        self.definition = definition
        self.definition.set_layer(self)
        self.image = None

        self.queryParameter = None
        self.extent = None     #query和export都要用到的参数

        self.store=GiserverStore
        engine = self.definition.engine
        self.store.set_engine(engine)

    def reload(self):
        pass

    def query(self,queryParameter):
        
        self.queryParameter = queryParameter
        self.extent =Extent(self.queryParameter.bbox)      #bbox
        
        aliases_dict,last_features=self.store.filter_data(self)
        
        aliases = aliases_dict.values()
        fields = aliases_dict.keys()
        gemetryType = self.definition.gemetryType 
        
        queryResult = QueryResult(aliases,fields,last_features,gemetryType)

        return queryResult


    def export(self,queryParameter,size):
        self.size = size
        self.bbox = queryParameter.bbox
        self.outsr = outsr
        self.image = Image.new("RGBA", self.size, (255,255,255,0))
        self.definition.style.rule.symbol.draw(self)
    
    def toScreen(self):
        pass

    def toGemtry(self):
        pass

class QueryParameter:
    def __init__(self,bbox,where,insr,outfields,outsr):
        self.bbox = bbox
        self.where = where
        self.insr = insr
        self.outfields = outfields.split(",")
        self.outsr = outsr

    @classmethod
    def create(cls,requestHandler):
        self.layer = requestHandler.get_argument("layer")
        self.bbox = requestHandler.get_argument("bbox")
        self.where = requestHandler.get_argument("where",None)
        self.insr = requestHandler.get_argument("insr")
        self.outfields = requestHandler.get_argument("outfields")
        self.outsr = requestHandler.get_argument("outsr")  

    def toString(self):
        pass    


class QueryResult:
    def __init__(self,aliases,fields,features,layer_type):
        self.aliases = aliases
        self.fields = fields
        self.features = features
        self.type = layer_type 

    def toString(self):
        pass    






